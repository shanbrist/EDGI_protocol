---
title: "Demographics"
author: "Christopher Huebel, Helena Davies, Dina Monssen"
date: "2022-08-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear Global Environment

```{r clear global environment}
rm(list = ls(all.names = TRUE)) 
```

Read in file with path to data channel
```{r Read in file with path to data channel on teams}
source(file = "../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0("functions/add_numeric.R"))
source(file = paste0("functions/remove_duplicates.R"))
source(file = paste0("functions/package_check.R"))
```

Load packages
```{r Load packages}
library(tidyverse)
library(gtsummary)
```

Set current date
```{r current date}
date <- Sys.Date()
```

Load data
```{r Load data}
dat <- read_rds(
  file = paste0(filepath_cleaned_data, "merged_dat.rds")
)
```

Overview variables
```{r Overview variables}
names(dat)
```

# Self-report and algorithm-derived ED diagnosis
```{r deriving self-report and algorithm-derived ED diagnosis}
# Anorexia nervosa
dat <- dat %>%
  mutate(anorexia_nervosa =
           case_when(ed.DSM5_AN_binary == "DSM5 AN" |
                       mhd.an_numeric == 1 ~ "Anorexia nervosa"))

# Bulimia nervosa
dat <- dat %>%
  mutate(bulimia_nervosa =
           case_when(ed.DSM5_BN_binary == "DSM-5 BN" |
                       mhd.bn_numeric == 1 ~ "Bulimia nervosa"))

# Binge-eating disorder
dat <- dat %>%
  mutate(binge_eating_disorder =
           case_when(ed.DSM5_BED_binary == "DSM-5 BED" |
                       mhd.bed_numeric == 1 ~ "Binge-eating disorder"))
```


```{r Mixed presentation}
dat <- dat %>%
  mutate(
    mixed_eating_disorders =
      case_when(
        anorexia_nervosa == "Anorexia nervosa" ~ "AN",
        
        bulimia_nervosa == "Bulimia nervosa" ~ "BN",
        
        binge_eating_disorder == "Binge-eating disorder" ~ "BED",
        
        anorexia_nervosa == "Anorexia nervosa" &
        bulimia_nervosa == "Bulimia nervosa" ~ "AN & BN",
       
        anorexia_nervosa == "Anorexia nervosa" &
        binge_eating_disorder == "Binge-eating disorder" ~ "AN & BED",
      
        bulimia_nervosa == "Bulimia nervosa" &
        binge_eating_disorder == "Binge-eating disorder" ~ "BN & BED",
        
        anorexia_nervosa == "Anorexia nervosa" &
        bulimia_nervosa == "Bulimia nervosa" &
        binge_eating_disorder == "Binge-eating disorder" ~ "AN & BN & BED"
      )
  )
```



```{r}
dat <- dat %>%
  head()

dat %>% 
  dim
```


```{r demographics}
exclude_columns_from_pivoting <-
  c(
    "ID",
    "dem.sex",
    "demographics.what_gender_do_you_identify_with",
    "dem.do_you_identify_as_transgender",
    "dem.what_is_your_sexual_orientation",
    "dem.what_is_your_ethnic_origin",
    "dem.highest_education_finegrained",
    "dem.what_is_your_current_employment_status",
    "dem.what_is_your_current_maritalrelationship_status",
    "dem.pack_year",
    "mhd.eating_disorder_received_treatment"
  )


dat_demographics <- dat %>%
  select(
    ID,
    dem.sex,
    demographics.what_gender_do_you_identify_with,
    dem.do_you_identify_as_transgender,
    dem.what_is_your_sexual_orientation,
    dem.what_is_your_ethnic_origin,
    dem.highest_education_finegrained,
    dem.what_is_your_current_employment_status,
    dem.what_is_your_current_maritalrelationship_status,
    dem.pack_year,
    mhd.eating_disorder_received_treatment,
    
    # Diagnosis
    anorexia_nervosa,
    bulimia_nervosa,
    binge_eating_disorder
  )



dat_demographics_long <- dat_demographics %>%
  pivot_longer(
    -exclude_columns_from_pivoting,
#    names_to = "Old_variable",
    values_to = "Disorder"
    ) %>%
  select(
    -name
  )

dat_demographics_long %>%
  head()
```


```{r demographics rds file}
dat_demographics %>%
write_rds(file = paste0(filepath_cleaned_data, "demographics.rds"))
```


# Table:  Age distribution of EDGI UK sample by age range and sex
```{r select age distribution data}
age_sex_distribution <- dat %>%
  select(ID,
         dem.dob_age, 
         dem.sex)
```

# Table: Distribution of lifetime eating disorders in EDGI Sample by gender and report type split by eating disorder diagnosis
```{r select age distribution data}
age_sex_distribution <- dat %>%
  select(ID,
         dem.dob_age, 
         dem.sex)
```















































```{r Psychiatric comorbidities}
exclude_columns_from_pivoting <-
  c(
    "ID",
    
    "mhd.depression_and_anxiety",
    "mhd.depressive_disorders",
    "mhd.anxiety_disorders",   
    "mhd.ptsd_numeric",
    
    "mhd.obsessive_compulsive_disorders",
    
    "mhd.personality_disorder_diagnosed_numeric",
    
    "mhd.bipolar_and_schizophrenia",
    "mhd.psychotic_disorders",
    "mhd.bipolar_disorder_numeric",
    
    "mhd.autism_spectrum_disorder",
    "mhd.addadhd_numeric"
  )


dat_psych_dx <- dat %>%
  select(
    all_of(exclude_columns_from_pivoting),

    # Diagnosis
    anorexia_nervosa,
    bulimia_nervosa,
    binge_eating_disorder
  )

dat_psych_dx_longer <- dat_psych_dx %>%
  pivot_longer(
    -exclude_columns_from_pivoting,
#    names_to = "Old_variable",
    values_to = "Disorder"
    ) %>%
  select(
    -name
  )


dat_psych_dx_longer %>%
  head()
```


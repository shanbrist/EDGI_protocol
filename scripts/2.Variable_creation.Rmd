---
title: "Demographics"
author: "Christopher Huebel, Helena Davies, Dina Monssen"
date: "2022-08-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear Global Environment

```{r clear global environment}
rm(list = ls(all.names = TRUE)) 
```

Read in file with path to data channel
```{r Read in file with path to data channel on teams}
source(file = "../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0("functions/add_numeric.R"))
source(file = paste0("functions/remove_duplicates.R"))
source(file = paste0("functions/package_check.R"))
```

Load packages

```{r Load packages}
library(tidyverse)
library(gtsummary)
```

Set current date

```{r current date}
date <- Sys.Date()
```

Load data

```{r Load data}
dat <- read_rds(
  file = paste0(filepath_cleaned_data, "merged_dat.rds")
)
```

Overview variables

```{r Overview variables}
names(dat)
```


```{r}
dat <- dat %>%
  mutate(
    combined_eating_disorders =
      case_when(
        ~ AN_only,
        ~ BN_only,
        ~ BED_only,
        ~ AN_BN
        ~ AN_BED,
        ~ BN_BED,
        ~ AN_BN_BED
      )
  )
```




```{r}
dat <- dat %>%
  top_n(n = 100)

dat %>% 
  dim
```


```{r}
exclude_columns_from_pivoting <-
  c(
    "ID",
    "dem.sex",
    "demographics.what_gender_do_you_identify_with",
    "dem.do_you_identify_as_transgender",
    "dem.what_is_your_sexual_orientation",
    "dem.what_is_your_ethnic_origin",
    "dem.highest_education_finegrained",
    "dem.what_is_your_current_employment_status",
    "dem.what_is_your_current_maritalrelationship_status",
    "dem.pack_year",
    "mhd.eating_disorder_received_treatment"
  )


dat_demographics <- dat %>%
  select(
    ID,
    dem.sex,
    demographics.what_gender_do_you_identify_with,
    dem.do_you_identify_as_transgender,
    dem.what_is_your_sexual_orientation,
    dem.what_is_your_ethnic_origin,
    dem.highest_education_finegrained,
    dem.what_is_your_current_employment_status,
    dem.what_is_your_current_maritalrelationship_status,
    dem.pack_year,
    mhd.eating_disorder_received_treatment,
    
    # Algorithm
#    "ed.DSM5_AN_binary",
    "ed.DSM5_AN_restricting_binary",
    "ed.DSM5_AN_binge_purge_binary",
    "ed.DSM5_BED_binary"    
  ) %>%
  pivot_longer(
    -exclude_columns_from_pivoting,
#    names_to = "Old_variable",
    values_to = "Disorder"
    ) %>%
  select(
    -name
  )

dat_demographics
```


```{r}
dat_demographics %>%
write_rds(file = paste0(filepath_cleaned_data, "demographics.rds"))
```

